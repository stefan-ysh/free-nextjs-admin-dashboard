# 测试清单（采购审批系统）

## 1. 环境与账号

1. 启动应用并确认可登录。
2. 至少准备三个账号：`员工`、`审批人(管理员/财务)`、`财务`。
3. 确认部门预算已配置（用于预算校验测试）。

## 2. 登录与权限

1. 员工账号可进入采购台账，不可进入流程配置。
2. 审批账号可进入采购审批、流程监控、流程配置。
3. 财务账号可进入付款任务、采购审批（若赋权）。
4. 无权限账号访问受限页面时显示“无权访问”。

## 3. 流程配置（可视化连线）

1. 打开 `采购管理 -> 流程配置` 页面成功加载节点。
2. 可新增节点、删除节点、上移/下移改变顺序。
3. 节点四周连接点可创建连线，连线可选中并删除。
4. 节点可配置：审批人类型（角色/指定人）、审批模式、超时小时、意见必填、金额范围、组织类型。
5. 点击“保存配置”后刷新页面，配置保持不丢失。
6. 关闭“启用流程”后保存，后续提交应不再按节点推进（只进入待审批）。

## 4. 采购申请创建

1. 新建采购，必填字段校验正确（物品、数量、单价、用途等）。
2. 上传附件、发票凭证可成功保存。
3. 金额为 0 的允许场景（按当前业务设定）行为正确。
4. 部门预算超限时，提交被阻止并提示“超出部门预算”。
5. 表单在桌面和移动端布局不挤压、字段宽度一致。

## 5. 提交与自动路由

1. 草稿提交后状态变为 `待审批`。
2. 提交后 `pending_approver_id` 被自动分配到规则命中的第一节点审批人。
3. 若首节点按角色匹配不到人，记录仍进入待审批但待审批人可为空。
4. 审批流快照已写入（用于后续节点推进）。

## 6. 审批动作（多节点）

1. 当前审批人执行“通过”后：
- 非最后节点：状态保持 `待审批`，自动切到下一节点审批人。
- 最后节点：状态变为 `已批准`。
2. 节点配置 `意见必填=true` 时，不填审批意见不能通过。
3. 节点配置 `意见必填=false` 时，可不填意见通过。
4. 驳回后状态变为 `已驳回`，可见驳回原因。
5. 转审可将当前审批人切换为指定人员，并记录日志。
6. 转审时不能转给自己，系统应提示并阻止提交。
7. 审批中心支持按金额区间、提交日期筛选。
8. 审批中心支持“仅看超时”与超时阈值筛选，超时记录有行高亮。

## 7. 付款任务与财务联动

1. 已批准但未提交报销（`invoice_pending`）的单据不应进入付款队列。
2. 申请人补发票并执行“提交报销”后，单据进入付款队列。
2. 打款后产生付款记录，状态按是否全额打款变更（部分/完成）。
3. 可标记付款异常并解除异常。
4. 付款记录可在采购详情和财务相关页面追溯。

## 7.1 短信通知（可选）

1. 配置 `SMS_NOTIFY_ENABLED=1` 且 webhook 正确后，提交采购会推送“待审批”短信。
2. 审批通过后，申请人会收到“可采购并补发票”通知。
3. 提交报销后，财务会收到“待财务确认”通知。
4. 打款完成后，申请人会收到“流程完成”通知。
5. 员工手机号存在时，消息应优先精准发到 `hr_employees.phone`。
6. 目标手机号缺失时，消息应自动回退到 `SMS_FALLBACK_*` 号码组，不应丢消息。

## 7.2 站内通知（in_app）

1. 在 `NOTIFY_POLICY_JSON` 中为对应事件开启 `in_app` 通道后，触发流程动作能在 `/m/notifications` 看到通知。
2. 员工提交采购后，审批人账号应收到“采购待审批”站内通知。
3. 审批通过后，申请人账号应收到“采购审批通过”站内通知。
4. 提交报销后，财务角色账号应收到“报销待财务确认”站内通知。
5. 财务打款后，申请人账号应收到“采购已完成打款”站内通知。

## 8. 流程监控页面

1. 打开 `采购管理 -> 流程监控` 页面成功。
2. 指标卡展示进行中、待审批、待付款、超时审批数量。
3. 可切换超时阈值（24/48/72h）并刷新结果。
4. 可查看节点分布、停留分布、审批人负载、卡点单据。

## 9. 审计与日志

1. 提交、审批、驳回、转审、打款、异常/解除异常均有日志。
2. 日志中的状态流转与操作人信息正确。
3. 采购详情中的时间轴与日志顺序一致。
4. `采购管理 -> 审计日志` 页面可按动作、日期、关键字筛选。
5. 审计日志支持导出当前页 CSV。

## 10. 回归与异常场景

1. 非当前审批人（且非管理员）不能审批/驳回/转审。
2. 草稿或驳回单可编辑；待审批/已批准/已打款不可编辑。
3. 多次快速点击审批按钮不会产生重复状态跳转。
4. 删除/撤回受状态限制，提示正确。
5. 重新提交驳回单后流程从首节点重新开始。

## 11. 数据核验（SQL 建议）

1. `purchases`：检查 `status`、`pending_approver_id`、`workflow_step_index`、`workflow_nodes`。
2. `purchase_workflow_configs`：检查流程配置是否保存。
3. `reimbursement_logs`：检查每次动作都有日志。
4. `purchase_payments`：检查付款金额与时间正确。

## 12. 表单抽屉宽度与布局回归

1. 打开以下“表单抽屉”并确认在 `1440px` 桌面宽度下字段不拥挤、无异常换行：
- 财务：`/finance` -> `+ 记一笔`
- 采购：`/purchases` -> `新增采购` / `编辑`
- 员工：`/employees` -> `新增员工` / `编辑员工`
- 库存：`/inventory` -> `创建入库单` / `创建出库单`
- 商品：`/inventory/items` -> `新建商品`
- 仓库：`/inventory/warehouses` -> `新建仓库`
- 部门：`/departments` -> `新增部门`
2. 在 `1024px` 和 `768px` 下重复检查，确认抽屉仍可完整操作，底部按钮可见。
3. 表单中短字段（如数量、单价、手续费、付款类型）应保持紧凑宽度，不应拉满整行。
4. 过滤抽屉与表单抽屉区分清晰：过滤抽屉可以较窄，表单抽屉应保持可编辑宽度。
5. 所有表格容器确认圆角已移除（`surface-table`），表头/内容/分页视觉一致。
