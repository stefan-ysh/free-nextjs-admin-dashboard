# 开发基线与注意事项（入口）

> 基线已拆分为“业务规范 + 技术规范”，请优先阅读以下两份文档：
- [BUSINESS_BASELINE.md](./BUSINESS_BASELINE.md)
- [ENGINEERING_BASELINE.md](./ENGINEERING_BASELINE.md)

---

> 以下内容为历史汇总，后续以拆分文档为准。

## 1. 角色与职责边界

当前仅保留以下角色：
- 超级管理员（`super_admin`）
- 审批管理员（`admin`）
- 学校财务（`finance_school`）
- 单位财务（`finance_company`）
- 员工（`employee`）

职责边界：
- 超级管理员：只做全局查看与兜底，不参与审批/打款等流程节点。
- 审批管理员：只处理采购审批，不处理报销打款。
- 财务（学校/单位）：只处理报销打款与驳回，不处理采购审批。
- 员工：发起采购、入库、发起报销、补充被驳回材料。

## 2. 流程定义（必须一致）

### 2.1 采购流程
- 流程：`采购申请 -> 审批管理员审批 -> 申请人入库`
- 审批通过后：采购单状态进入 `pending_inbound`（待入库）。
- 采购流程不再有独立“财务打款”节点，视为审批通过后已完成采购付款语义。

### 2.2 报销流程
- 报销入口独立于采购，可直接发起。
- 可选择“关联采购单”或“不关联采购单”。
- 关联采购单时，必须满足：
  - 采购单非对公转账（`payment_method != corporate_transfer`）
  - 采购单已入库
  - 同一采购单不可重复关联多张报销单
- 流程：`提交报销 -> 财务处理（打款/驳回）`
- 财务驳回后：申请人可编辑补料并重新提交。

## 3. 待办 / 已办规则

统一原则：
- 待办：当前登录角色“还需要执行动作”的记录。
- 已办：当前登录角色“已经执行过动作”的记录。
- 草稿不算待办（流程尚未开始）。
- 取消“在途”模块，所有角色统一只展示“待办/已办”。
- 待办和已办使用统一列表，不按模块拆多个卡片分区。

## 4. 数据与表结构边界

### 4.1 已下线（禁止再依赖）
- `purchase_payments`
- `purchase_workflow_configs`
- `projects`
- `project_payments`
- `calendar_events`
- `clients`
- `client_contacts`
- `client_logs`

### 4.2 财务记录来源（`finance_records.source_type`）
- `manual`
- `reimbursement`
- `budget_adjustment`
- `inventory`

### 4.3 预算调整
- 新表：`finance_budget_adjustments`
- 由财务角色维护预算增减。
- 每次预算调整同时写入一条 `finance_records` 流水，便于收支统计。

## 5. 关键权限约束

- 采购监控、审计记录：仅“审批管理员及以上可见”（财务不看）。
- 员工新增受限权限：`INVENTORY_INBOUND_CREATE_OWN_PURCHASE_ONLY`
  - 仅可入库本人且已审批采购单。
  - 不可改库存主数据。

## 6. 交互与文案规范

- 所有用户可见错误必须是可理解中文，明确“哪里错了/如何处理”。
- 所有“操作人”展示必须显示姓名，不显示 UUID。
- 报销详情页为只读视图，禁止在“详情”场景下上传或编辑。
- “去打款”建议命名为“去处理”（因包含核对+驳回+打款）。

## 7. 附件与存储规范

- 已接入腾讯云 COS 存储。
- 附件展示优先显示原始文件名（非存储键名）。
- 预览优先在当前弹窗内完成，不强依赖新窗口。
- 若遇 `AccessDenied`：优先检查签名 URL、桶权限、CORS、路径前缀一致性。

## 8. 日期与时区规范

- 前端表单日期统一使用 shadcn UI 日期组件。
- 日期落库与展示统一按中国时区（Asia/Shanghai）语义处理。
- 所有日期字段禁止隐式 UTC 偏移导致的“前后一天”问题。

## 9. 开发与回归检查清单（每次发版前）

1. 采购提交/审批/入库全链路可用。
2. 报销提交/财务驳回/补料重提/财务打款全链路可用。
3. 学校组织仅流向学校财务，单位组织仅流向单位财务。
4. 待办角标数量与列表数据一致。
5. 菜单仅高亮单一路径，无多菜单同时高亮。
6. 报销状态文案全部中文化（无英文枚举泄漏）。
7. 关联采购下拉不出现不可用项（对公转账、已被关联、未入库）。
8. 附件可上传、可预览、可回显文件名。
9. `npm run build` 通过。

## 10. 数据清理与迁移

- 清理脚本：`scripts/cleanup_removed_modules.sql`
- 预检查命令：`npm run check:cleanup-removed`
- 执行手册：`docs/REMOVED_MODULES_CLEANUP.md`
- 用途：清除已下线模块表与旧字段外键。
- 执行前务必备份数据库。
- 禁止直接清空员工、角色、物品目录等系统主数据。

## 11. 未来开发原则

- 新需求优先判断是否破坏第 1~4 节基线。
- 任何流程调整必须同步更新：
  - 权限
  - 待办/已办聚合口径
  - 通知文案
  - 数据迁移脚本
- 未经确认不得引入“跨角色混合职责”的节点。
